#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# description: event trigger - test objtrace-trigger
# requires: kprobe_events

fail() { #msg
    echo $1
    exit_fail
}

echo 'p bio_add_page arg1=$arg1' > kprobe_events

FEATURE=`grep objtrace events/kprobes/p_bio_add_page_0/trigger`
if [ -z "$FEATURE" ]; then
    echo "objtrace trigger is not supported"
    exit_unsupported
fi

echo "Test objtrace trigger"
echo 'objtrace:add:0x28(arg1):u32:1 if comm == "cat"' > \
	events/kprobes/p_bio_add_page_0/trigger
if [ -z $? ]; then
	fail "objtrace trigger syntax error"
fi

echo "Test objtrace semantic errors"

# Being lack of type size
! echo 'objtrace:add:0x28(arg1):1' > events/kprobes/p_bio_add_page_0/trigger
# Being lack of objtrace command
! echo 'objtrace:0x28(arg1):u32:1' > events/kprobes/p_bio_add_page_0/trigger
# Bad parameter name
! echo 'objtrace:add:argx:u32:1' > events/kprobes/p_bio_add_page_0/trigger

echo "reset objtrace trigger"

echo '!objtrace:add:0x28(arg1):u32' > \
	events/kprobes/p_bio_add_page_0/trigger
echo '-:p_bio_add_page_0' >> ./kprobe_events

exit 0
